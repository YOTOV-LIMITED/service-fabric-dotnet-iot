<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Service-fabric-dotnet-iot by YOTOV-LIMITED</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Service-fabric-dotnet-iot</h1>
      <h2 class="project-tagline">An end-to-end sample that demonstrates an IoT application combining Service Fabric with other Azure services.</h2>
      <a href="https://github.com/YOTOV-LIMITED/service-fabric-dotnet-iot" class="btn">View on GitHub</a>
      <a href="https://github.com/YOTOV-LIMITED/service-fabric-dotnet-iot/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/YOTOV-LIMITED/service-fabric-dotnet-iot/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <hr>

<p>services: service-fabric
platforms: dotnet</p>

<h2>
<a id="author-vturecek" class="anchor" href="#author-vturecek" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>author: vturecek</h2>

<h1>
<a id="service-fabric-iot-sample" class="anchor" href="#service-fabric-iot-sample" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Service Fabric IoT Sample</h1>

<p>This sample project demonstrates a multi-tenant IoT solution using Azure IoT Hub for device message ingress and Azure Service Fabric for device message access and processing. </p>

<h2>
<a id="setup" class="anchor" href="#setup" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Setup</h2>

<ol>
<li>
<a href="https://azure.microsoft.com/documentation/articles/service-fabric-get-started/">Set up your Service Fabric development environment</a>.</li>
<li>
<a href="https://azure.microsoft.com/documentation/articles/iot-hub-csharp-csharp-getstarted/#create-an-iot-hub">Create an IoT Hub in Azure</a> or use an existing IoT Hub in your Azure subscription that is not currently being used in a production application. If you're creating a new IoT Hub to run the sample, you can simply use the <strong>F1 - Free</strong> tier under <strong>pricing and scale tier</strong> in the Azure portal. </li>
</ol>

<h2>
<a id="deploy" class="anchor" href="#deploy" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Deploy</h2>

<ol>
<li>Make sure you have a local cluster running</li>
<li>Open a PowerShell window and CD to <code>service-fabric-dotnet-iot\build</code>
</li>
<li>Connect to your cluster using <code>Connect-ServiceFabricCluster</code>.</li>
<li>Run <code>.\deploy.ps1</code>
</li>
</ol>

<h2>
<a id="view-application-traces" class="anchor" href="#view-application-traces" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>View application traces</h2>

<ol>
<li>Open the solution in Visual Studio.</li>
<li>Open the Diagnostics Event viewer: View -&gt; Other Windows -&gt; Diagnostic events</li>
<li>
<p>In the Diagnostics Event viewer, click the Configuration button with the gear icon, and replace the existing ETW providers with the following ETW providers, then click "Apply."</p>

<pre><code>Microsoft-Iot.Ingestion.RouterService
Microsoft-IoT.Admin.WebService
Microsoft-IoT.Tenant.WebService
Microsoft-IoT.Tenant.DataService
Microsoft-ServiceFabric-Services
</code></pre>
</li>
</ol>

<h2>
<a id="have-fun" class="anchor" href="#have-fun" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Have fun</h2>

<ol>
<li>Once the application deployment has completed, go to <code>http://localhost:8081/iot</code> in a web browser to access the admin web UI.</li>
<li>Using the admin UI, create an ingestion application. Give it any name, your [IoT Hub connection string], and click "Add."(<a href="https://azure.microsoft.com/documentation/articles/iot-hub-csharp-csharp-getstarted/#create-an-iot-hub">https://azure.microsoft.com/documentation/articles/iot-hub-csharp-csharp-getstarted/#create-an-iot-hub</a>).</li>
<li>Using the admin UI, create a tenant application. Give it any name, any number of data service partitions, 1 web service instance if running locally, or -1 if running it Azure, and click "Add."</li>
<li>Once the tenant application is created, click the "Web portal" link to see the tenant's dashboard. <em>Note:</em> It may take a minute for the web portal to become available.</li>
<li>Run the simple device emulator that's included with the sample under <code>service-fabric-dotnet-iot\src\Iot.DeviceEmulator</code>.

<ol>
<li>Open the solution in Visual Studio 2015.</li>
<li>Set the Iot.DeviceEmulator project as the start-up project and press F5 or ctrl+F5 to run it.</li>
<li>Follow the instructions in the command prompt to register devices with IoT Hub and send messages to the tenant application created in step 3.</li>
</ol>
</li>
</ol>

<h2>
<a id="clean-up" class="anchor" href="#clean-up" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Clean up</h2>

<ol>
<li>Open a PowerShell window and CD to <code>service-fabric-dotnet-iot\build</code>
</li>
<li>Run <code>.\obliterate.ps1</code>
</li>
</ol>

<h2>
<a id="conceptual-overview" class="anchor" href="#conceptual-overview" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Conceptual overview</h2>

<p>In this example, the system allows an adminstrator to add any number of "tenants" to the system to consume messages from device field gateways through any number of IoT Hub instances. Tenants can view their devices and device messages through a Web UI. Messages sent from devices are expected to include a tenant name and device ID for the message ingestion application to determine which tenant to send the message to.</p>

<p><img src="./docs/conceptual.png" alt="Conceptual"></p>

<h3>
<a id="patterns-demonstrated-in-this-sample" class="anchor" href="#patterns-demonstrated-in-this-sample" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Patterns demonstrated in this sample</h3>

<ul>
<li>Reading messages from IoT Hub with <a href="https://msdn.microsoft.com/library/microsoft.servicebus.messaging.eventhubreceiver.aspx">EventHubReceiver</a>. A partitioned stateful Service Fabric service provides a simple and intuitive way to read from IoT Hub partitions by simply mapping stateful service partitions to IoT Hub partitions one-to-one. This approach does not require any addition coordination or leasing between IoT Hub readers. Service Fabric manages creation, placement, availability, and scaling of the stateful service partitions. A Reliable Collection is used in each partition to keep track of the position, or <em>offset</em> in the IoT Hub event stream.</li>
<li>Multi-tenancy using dynamically-created named application instances. An administrative application uses the Service Fabric management APIs to create a new named application instance for each new tenant, so that each tenant gets their own instance of the message storing and processing service, isolated from other tenants.</li>
<li>Service-to-service communication using HTTP with ASP.NET Core. Services expose HTTP endpoints to communicate with other services.</li>
</ul>

<h2>
<a id="architectural-overview" class="anchor" href="#architectural-overview" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Architectural overview</h2>

<p>This example makes use of several Azure products:</p>

<ul>
<li>
<strong>IoT Hub</strong> for device management and device message ingress.</li>
<li>
<strong>Service Fabric</strong> hosts the message processing applications. </li>
<li>
<strong>Azure Storage (optional)</strong> can optionally be used for long-term message storage, but is not shown in this example.</li>
</ul>

<p><img src="./docs/overview.png" alt="Overview"></p>

<h3>
<a id="structure" class="anchor" href="#structure" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Structure</h3>

<p>The solution is composed of three separate Service Fabric applications, each with their own set of services:</p>

<h4>
<a id="admin-application" class="anchor" href="#admin-application" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Admin Application</h4>

<p>Used by an adminstrator to create instances of the Ingestion Application and Tenant Application.</p>

<ul>
<li>
<strong>Web Service</strong>: The only service in this application, the web service is a stateless ASP.NET Core service that presents a management UI. API controllers perform Service Fabric management operations using <code>FabricClient</code>. </li>
</ul>

<h4>
<a id="ingestion-application" class="anchor" href="#ingestion-application" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Ingestion Application</h4>

<p>An instance of this application connects to an IoT Hub, reads device events, and forwards data to the tenant identified in the device event message.</p>

<ul>
<li>
<p><strong>Router Service</strong>: The only service in this application, the router service is the stateful partitioned service that connects to IoT Hub and forwards device messages to the appropriate tenant application.</p>

<h4>
<a id="tenant-application" class="anchor" href="#tenant-application" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Tenant Application</h4>

<p>A tenant is a user of the system. The system can have multiple tenants. Device event data flows into tenant applications for viewing and processing.</p>
</li>
<li>
<strong>Data Service</strong>: A stateful service that holds the most recent device message for a tenant. This service is partitioned so that tenants with a large number of devices can scale horizontally to meet their requirements. </li>
<li>
<strong>Web Service</strong>: A stateless ASP.NET Core service that presents a UI for the tenant to see devices and their most recent messages. </li>
</ul>

<h3>
<a id="deployment" class="anchor" href="#deployment" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Deployment</h3>

<p>This sample project <strong>does not</strong> create instances of each application during deployment time. The project is designed to create new application instances at runtime through the Admin UI. In order to create application instances at runtime, the application types must be registered at deployment time. A fresh deployment of this sample looks like this:</p>

<ul>
<li>IoTAdminApplicationType

<ul>
<li>fabric:/IoT.Admin.Application</li>
</ul>
</li>
<li>IotIngestionApplicationType</li>
<li>
<p>IotTenantApplicationType</p>

<p>Note that only the IoTAdminApplicationType has a named instance running. The other two application types are registered, but no named application instances are created by default. The web UI in the admin application is used to dynamicall create named instances of the other two applications.</p>
</li>
</ul>



      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/YOTOV-LIMITED/service-fabric-dotnet-iot">Service-fabric-dotnet-iot</a> is maintained by <a href="https://github.com/YOTOV-LIMITED">YOTOV-LIMITED</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
